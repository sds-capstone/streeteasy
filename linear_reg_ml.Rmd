---
title: "linear_reg_ml"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(tidymodels)
library(leaps)
library(MLmetrics)
library(caret)
```


```{r message=FALSE, warning=FALSE}
#use imputed data for linear model 
source("pre-processing.R")
load_data() # creates two dataframes in the global environment

clean_data() # cleans the data

sale_listings_imputed <- impute_data() # imputes size values and returns a new dataframe

ml_setup(sale_listings_imputed) 

#+1, -1 are supposed to optimize rmlse, but it seems like the result is the same at this point 
train <- train %>%
  mutate(log10price = log10(price + 1)) %>%
  mutate(log10size = log10(size_sqft))

test <- test %>%
  mutate(log10size = log10(size_sqft))
```

## Model Fitting
```{r}
#major city has 66 levels, zipcode has over 200, county has 12
#not sure how to deal with categorical var 
model.seq <- regsubsets(log10price ~ bedrooms +
                          bathrooms + 
                          log10size +
                          floor_count +
                          size_sqft + 
                          year_built +
                          is_historic +
   #                       county + 
                          state,
                        data = train,
                        nvmax = 8,
                        method = "seqrep"
)
# 6-predictor model seems to perform the best: bathrooms, log10size, floor_count, size_sqft, is_historic, state
# think it makes sense to add bedrooms and delete size_sqft since we already have log10size
with(summary(model.seq), data.frame(rsq, adjr2, rss, cp, outmat))
mod1 <- lm(log10price ~ bedrooms + 
             bathrooms +
             log10size +
            state + 
             floor_count +
             is_historic,
           data = train
)
# why n. bedrooms have negative relationship with price??? 
summary(mod1)
```

## Cross Validation 

```{r}
data_ctrl <- trainControl(method = "cv", number = 5)
model_caret <- train(log10price ~ bedrooms + 
             bathrooms +
             log10size +
            state + 
             floor_count +
             is_historic, 
            data = train, 
             method = "lm",                      
            na.action = na.pass)
```


## Making Prediction on Test
```{r}
test <- test %>%
  mutate(
    log10price_hat = predict(model_caret, test),
    price_hat = 10^log10price_hat - 1
  )

rmsle_lm <- RMSLE(test$price_hat, test$price)
rmsle_lm
MLmetrics::RMSE(test$price_hat, test$price)
#rmsle = .5191448
#rmse = 735443.3
#Null model RMSLE: .7345286
#null model RMSLE: 916221.5
```

Reference: 
https://stackoverflow.com/questions/58129132/error-in-lm-fitx-y-offset-offset-singular-ok-singular-ok-na-nan

http://www.science.smith.edu/~jcrouser/SDS293/labs/lab8-r.html

https://bookdown.org/tpinto_home/Regularisation/best-subset-selection.html#bss.intro
