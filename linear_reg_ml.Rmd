---
title: "linear_reg_ml"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(tidymodels)
library(leaps)
library(MLmetrics)
```


```{r message=FALSE, warning=FALSE}
#use imputed data for linear model 
source("pre-processing.R")
load_data() # creates two dataframes in the global environment

clean_data() # cleans the data

sale_listings_imputed <- impute_data() # imputes size values and returns a new dataframe

ml_setup(sale_listings_imputed) 

head(train)

train <- train %>%
  mutate(log10price = log10(price)) %>%
  mutate(log10size = log10(size_sqft))

test <- test %>%
  mutate(log10price = log10(price)) %>%
  mutate(log10size = log10(size_sqft))

```

## Model Fitting
```{r}
#major city has 66 levels, zipcode has over 200, county has 12
#not sure how to deal with categorical var 
model.seq <- regsubsets(log10price ~ bedrooms +
                          bathrooms + 
                          log10size +
                          floor_count +
                          size_sqft + 
                          year_built +
                          is_historic +
   #                       county + 
                          state,
                        data = train,
                        nvmax = 8,
                        method = "seqrep"
)
# 6-predictor model seems to perform the best: bathrooms, log10size, floor_count, size_sqft, is_historic, state
# think it makes sense to add bedrooms and delete size_sqft since we already have log10size
with(summary(model.seq), data.frame(rsq, adjr2, rss, cp, outmat))
mod1 <- lm(log10price ~ bedrooms + 
             bathrooms +
             log10size +
            state + 
             floor_count +
             is_historic,
           data = train
)
# why n. bedrooms have negative relationship with price??? 
summary(mod1)
```

## Cross Validation 
```{r}
# stole code from Albert's class
# 5-fold cross-validation
train <- train %>%
  sample_frac(1) %>%
  mutate(fold = rep(1:5, length = n())) %>%
  arrange(fold)
RMLSE <- rep(0, 5)
for (j in 1:5) {
  pretend_training <- train %>%
    filter(fold != j)
  pretend_test <- train %>%
    filter(fold == j)
  # Fit model on pretend training
  mod1 <- lm(log10price ~ bedrooms + 
             bathrooms +
             log10size +
            state + 
             floor_count +
             is_historic,
           data = train
  )
  # Making prediction using broom()
  Model_prediction <- mod1 %>%
    broom::augment(newdata = pretend_test) %>%
    mutate(.fitted = 10^.fitted)
  pretend_test <- pretend_test %>%
    mutate(price_hat = Model_prediction$.fitted)
 RMLSE[j] <- pretend_test %>%
   mutate(
     residual = log(price + 1) - log(price_hat + 1),
      residual_sq = residual^2
    ) %>%
    summarize(
      MLSE = mean(residual_sq, na.rm = TRUE),
      RMLSE = sqrt(MLSE)
    ) %>%
    pull(RMLSE)
#don't know why i can't store subsets of RMSLE using the function 
#  RMSLE[j] <- RMSLE(pretend_test$price_hat, pretend_test$price) 
}
rmlse <- mean(RMLSE)
rmlse
# rmlse = .5241
```

## Making Prediction on Test
```{r}
Model_prediction <- mod1 %>%
  broom::augment(newdata=test) %>%
  mutate(.fitted = 10^.fitted)


test <- test %>%
  mutate(SalePrice_hat = Model_prediction$.fitted)

rmsle_lm <- RMSLE(test$SalePrice_hat, test$price)
rmsle_lm
MLmetrics::RMSE(test$SalePrice_hat, test$price)
#rmsle = .5191448
#rmse = 735443.8
#Null model RMSLE: .7345286
#null model RMSLE: 916221.5
```




Reference: 
https://stackoverflow.com/questions/58129132/error-in-lm-fitx-y-offset-offset-singular-ok-singular-ok-na-nan

http://www.science.smith.edu/~jcrouser/SDS293/labs/lab8-r.html

https://bookdown.org/tpinto_home/Regularisation/best-subset-selection.html#bss.intro
